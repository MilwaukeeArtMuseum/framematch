<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.6.2.min.js"></script>

    

	<script>

	var canvas, stage;

	var mouseTarget;	// the display object currently under the mouse, or being dragged
	var dragStarted;	// indicates whether we are currently in a drag operation
	var offset;
	var update = true;
	var bgColor = "#5154d2";
	var buttonColor = "#3032b0";
	var skyColor = "#08a5ff";//"#734d73";
	var grassColor= "#08cca5";
	var backButton;
	var isOverlay = true;
	var objContainer;
	var overlay; 

	function init() {
		if (window.top != window) {
			document.getElementById("header").style.display = "none";
		}
		document.getElementById("loader").className = "loader";
		// create stage and point it to the canvas:
		canvas = document.getElementById("testCanvas");
	
		//check to see if we are running in a browser with touch support
		stage = new createjs.Stage(canvas);
		createjs.Touch.enable(stage);

		// enable touch interactions if supported on the current device:
		createjs.Touch.enable(stage);

		// enabled mouse over / out events
		stage.enableMouseOver(10);
		stage.mouseMoveOutside = true; // keep tracking the mouse even when it leaves the canvas

		// load the source image:
		var image = new Image();
		image.src = "./img/art/01.png";

		var objLoader = new createjs.LoadQueue(true);
		
		objLoader.on("fileload", handleObjLoad, this);
		objLoader.on("complete", handleObjComplete, this);

var objManifest = [
{src:"img/dragdrop/object03.png", id:"object03", data:{x:37, y:129}},
{src:"img/dragdrop/object34.png", id:"object34", data:{x:38, y:127}},
{src:"img/dragdrop/object33.png", id:"object33", data:{x:69, y:168}},
{src:"img/dragdrop/object35.png", id:"object35", data:{x:118, y:141}},
{src:"img/dragdrop/object43.png", id:"object43", data:{x:371, y:64}},
{src:"img/dragdrop/object49.png", id:"object49", data:{x:452, y:41}},
{src:"img/dragdrop/object31.png", id:"object31", data:{x:387, y:28}},
{src:"img/dragdrop/object44.png", id:"object44", data:{x:314, y:43}},
{src:"img/dragdrop/object12.png", id:"object12", data:{x:511, y:48}},
{src:"img/dragdrop/object28.png", id:"object28", data:{x:572, y:44}},
{src:"img/dragdrop/object40.png", id:"object40", data:{x:652, y:51}},
{src:"img/dragdrop/object02.png", id:"object02", data:{x:655, y:52}},
{src:"img/dragdrop/object01.png", id:"object01", data:{x:655, y:55}},
{src:"img/dragdrop/object45.png", id:"object45", data:{x:734, y:26}},
{src:"img/dragdrop/object47.png", id:"object47", data:{x:801, y:70}},
{src:"img/dragdrop/object38.png", id:"object38", data:{x:820, y:22}},
{src:"img/dragdrop/object41.png", id:"object41", data:{x:913, y:45}},
{src:"img/dragdrop/object48.png", id:"object48", data:{x:52, y:51}},
{src:"img/dragdrop/object39.png", id:"object39", data:{x:215, y:31}},
{src:"img/dragdrop/object46.png", id:"object46", data:{x:151, y:74}},
{src:"img/dragdrop/object06.png", id:"object06", data:{x:748, y:596}},
{src:"img/dragdrop/object25.png", id:"object25", data:{x:922, y:635}},
{src:"img/dragdrop/object52.png", id:"object52", data:{x:88, y:236}},
{src:"img/dragdrop/object05.png", id:"object05", data:{x:961, y:564}},
{src:"img/dragdrop/object04.png", id:"object04", data:{x:934, y:469}},
{src:"img/dragdrop/object08.png", id:"object08", data:{x:936, y:470}},
{src:"img/dragdrop/object24.png", id:"object24", data:{x:935, y:469}},
{src:"img/dragdrop/object15.png", id:"object15", data:{x:427, y:655}},
{src:"img/dragdrop/object13.png", id:"object13", data:{x:600, y:594}},
{src:"img/dragdrop/object14.png", id:"object14", data:{x:495, y:582}},
{src:"img/dragdrop/object16.png", id:"object16", data:{x:425, y:582}},
{src:"img/dragdrop/object07.png", id:"object07", data:{x:490, y:648}},
{src:"img/dragdrop/object19.png", id:"object19", data:{x:854, y:572}},
{src:"img/dragdrop/object11.png", id:"object11", data:{x:351, y:609}},
{src:"img/dragdrop/object37.png", id:"object37", data:{x:256, y:616}},
{src:"img/dragdrop/object23.png", id:"object23", data:{x:35, y:660}},
{src:"img/dragdrop/object22.png", id:"object22", data:{x:102, y:661}},
{src:"img/dragdrop/object21.png", id:"object21", data:{x:178, y:665}},
{src:"img/dragdrop/object51.png", id:"object51", data:{x:101, y:592}},
{src:"img/dragdrop/object50.png", id:"object50", data:{x:935, y:266}},
{src:"img/dragdrop/object32.png", id:"object32", data:{x:964, y:191}},
{src:"img/dragdrop/object30.png", id:"object30", data:{x:899, y:139}},
{src:"img/dragdrop/object10.png", id:"object10", data:{x:973, y:345}},
{src:"img/dragdrop/object09.png", id:"object09", data:{x:908, y:371}},
{src:"img/dragdrop/object42.png", id:"object42", data:{x:48, y:404}},
{src:"img/dragdrop/object27.png", id:"object27", data:{x:50, y:309}},
{src:"img/dragdrop/object29.png", id:"object29", data:{x:111, y:346}},
{src:"img/dragdrop/object53.png", id:"object53", data:{x:86, y:483}},
{src:"img/dragdrop/object18.png", id:"object18", data:{x:124, y:730}},
{src:"img/dragdrop/object17.png", id:"object17", data:{x:345, y:726}},
{src:"img/dragdrop/object20.png", id:"object20", data:{x:517, y:729}},
{src:"img/dragdrop/object26.png", id:"object26", data:{x:647, y:697}}];

		objContainer = new createjs.Container();

		objLoader.loadManifest(objManifest);
		createjs.Ticker.addEventListener("tick", stage);

		var bg = new createjs.Shape();
		bg.graphics.beginFill(bgColor);
		bg.graphics.drawRect(0,0,1024,768);
		bg.graphics.endFill();

		frame = new createjs.Bitmap("img/dragdrop/frame.png");
		
		frame.x = 170;
		frame.y = 100;

		overlay = new createjs.Bitmap("img/dragdrop/overlay.png");
		overlay.x = 150;
		overlay.y = 50;

		overlay.on("pressmove", function(evt) {
			this.parent.removeChild(this);
		});

		var sky = new createjs.Shape();
		sky.graphics.beginFill(skyColor);
		sky.graphics.drawRect(frame.x+5,frame.y+5,670,420);
		sky.graphics.endFill();

		var grass = new createjs.Shape();
		grass.graphics.beginFill(grassColor);
		grass.graphics.drawRect(frame.x,frame.y+230,670,190);
		grass.graphics.endFill();

		backButton = createButton(880, 690, 140, 'RESET', resetObjects);
		saveButton = createButton(740, 690, 120, 'SAVE', saveImage);
		stage.addChild(bg, sky, grass, objContainer, frame, backButton, saveButton, overlay);		
		
		//image.onload = handleImageLoad;



	}

	function stop() {
		//createjs.Ticker.removeEventListener("tick", tick);
	}
	function handleObjComplete(event) {
		stage.update();
	}
	function handleFrameLoad(event) {
		
	}

	function createButton(x, y, w, labelText, clickFunction) {
		
		var btn = new createjs.Container();
		
		btn.cursor = "pointer";

		var btnBG = new createjs.Shape();

		btnBG.graphics.beginFill(buttonColor).drawRoundRect(-20, -20, w, 75, 15).endFill();

		var btnTXT = new createjs.Text(labelText, "30px Arial", "#eee");

		btn.bg = btnBG;
		btn.txt = btnTXT;

		btn.addChild(btnBG, btnTXT);
		btn.y = y;
		btn.x =x;
		
		
		btn.on("mousedown", function(evt) {
			clickFunction();
		});

		return btn;

	}

	function outputDebug() {
		var n = objContainer.getNumChildren();
		var o = $("#debugText");
		


		o.append("var objManifest = [\n");
		
		var oc = "";
		for(i = 0; i < n; i++) {

			var c = objContainer.getChildAt(i);
			
			oc += '{src:"img/dragdrop/'+c.name +'.png", id:"'+c.name+'", data:{x:' + c.x + ', y:' + c.y + "}},\n";

			//document.getElementById("debug").value = "{x:" + c.x + ", y:" + c.y + "}";	
		}
		
		oc = oc.substr(0, oc.length - 2);

		o.append( oc + '];');

	}
	function saveImage() {
		// more user friendly: http://greenethumb.com/article/1429/user-friendly-image-saving-from-the-canvas/

		var outputCan = document.getElementById("c2");
		var outputImg = outputCan.getContext('2d');

		//call its drawImage() function passing it the source canvas directly
		// context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);
		outputImg.drawImage(canvas, 170,100,675,431,0,0,675,431);


		var image = outputCan.toDataURL("image/png").replace("image/png", "image/octet-stream");
		
		window.location.href=image; // it will save locally

	}


	function resetObjects() {
		

		var n = objContainer.getNumChildren();
		for(i = 0; i < n; i++) {
			var c = objContainer.getChildAt(i);
			createjs.Tween.get(c).to({x:c.origX, y:c.origY}, 500, createjs.Ease.circOut); //circOut is really nice
			//c.x = c.origX;
			//c.y = c.origY;
		}
	}

	function handleObjLoad(event) {


		var item = event.item;
		var image = event.result;
		var bitmap;
		
		//var container = new createjs.Container();
		
		console.log(image);
		// create and populate the screen with random daisies:

		bitmap = new createjs.Bitmap(image);
		objContainer.addChild(bitmap);
		bitmap.x = item.data.x;
		bitmap.y = item.data.y;
		
		bitmap.origX = item.data.x;
		bitmap.origY = item.data.y;

		//bitmap.rotation = 360 * Math.random()|0;
		bitmap.regX = bitmap.image.width/2|0;
		bitmap.regY = bitmap.image.height/2|0;
		bitmap.scaleX = bitmap.scaleY = bitmap.scale = 0.5;//Math.random()*0.4+0.6;
		bitmap.name = item.id;
		bitmap.cursor = "pointer";
		
		// using "on" binds the listener to the scope of the currentTarget by default
		// in this case that means it executes in the scope of the button.
		bitmap.on("mousedown", function(evt) {
			this.parent.addChild(this);
			this.offset = {x:this.x-evt.stageX, y:this.y-evt.stageY};
			if(isOverlay) {
				isOverlay = false;
				createjs.Tween.get(overlay).to({alpha:0}, 500).call(function() {overlay.parent.removeChild(overlay);}); //circOut is really nice
				//overlay.parent.removeChild(overlay);
			}
			
		});
		
		// the pressmove event is dispatched when the mouse moves after a mousedown on the target until the mouse is released.
		bitmap.on("pressmove", function(evt) {
			this.x = evt.stageX+ this.offset.x;
			this.y = evt.stageY+ this.offset.y;
			// indicate that the stage should be updated on the next tick:
			update = true;
		});
		
		bitmap.on("rollover", function(evt) {
			this.scaleX = this.scaleY = this.scale*1.1;
			update = true;
		});
		
		bitmap.on("rollout", function(evt) {
			this.scaleX = this.scaleY = this.scale;
			update = true;
		});


		//document.getElementById("loader").className = "";
		//stage.addChild(container);
	}

	
	</script>
	<style type="text/css">
		body {
			background-color: #5e62d4;
		}
		.canvasHolder {
			margin-top: 20px;

		}
		#testCanvas {
			padding: 15px;
			border: 1px solid #8888cc;
			background-color: #5154d2;
		}
	</style>

</head>

<body onload="init();">

	<div id="loader"></div>

	<center>
	<div class="canvasHolder">
		<canvas id="testCanvas" width="1024" height="768"></canvas>
		<canvas id="c2" width="675" height="431" style="display:none;"></canvas>
	</div>
	</center>
	<!--<input type="text" id="debug">-->
	<!--
	<input type="button" id="debugButton" value="debug" onclick="outputDebug();" />
	<textarea id="debugText" style="width:500px; height: 800px;"></textarea>
	-->

	 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')</script>

        <script src="http://code.createjs.com/easeljs-0.7.1.min.js"></script>
        <script src="http://code.createjs.com/tweenjs-0.5.1.min.js"></script>
        <script src="http://code.createjs.com/preloadjs-0.4.1.min.js"></script>
        <script src="http://code.createjs.com/soundjs-0.5.2.min.js"></script>
	<script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src='//www.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
</body>
</html>
